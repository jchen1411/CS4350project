import java.sql.*;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Scanner;

public class PomonaTransitSystem {

    public static void main(String[] args) {
        // Check connectivity
        if (DatabaseConnectivity.checkConnection()) {
            System.out.println("Connection successful.");
            
            TripSchedule.displaySchedule("LA", "NY", "2024-08-02"); // Correct format "YYYY-MM-DD"
            System.out.println();

            Scanner scanner = new Scanner(System.in);
            TripOfferingEditor editor = new TripOfferingEditor();

            while (true) {
                System.out.println("\nPomona Transit System - Choose an option:");
                System.out.println("1. View trip schedule");
                System.out.println("2. Delete a trip offering");
                System.out.println("3. Add new trip offerings");
                System.out.println("4. Change driver for a trip offering");
                System.out.println("5. Change bus for a trip offering");
                System.out.println("6. Exit");
                System.out.print("Enter your choice: ");
                int choice = scanner.nextInt();
                scanner.nextLine();  // Consume newline

                switch (choice) {
                    case 1:
                        System.out.println("Enter Start Location Name:");
                        String startLocationName = scanner.nextLine();
                        System.out.println("Enter Destination Name:");
                        String destinationName = scanner.nextLine();
                        System.out.println("Enter Date (YYYY-MM-DD):");
                        String date = scanner.nextLine();
                        TripSchedule.displaySchedule(startLocationName, destinationName, date);
                        break;
                    case 2:
                        System.out.println("Enter TripNumber to delete:");
                        String tripNumberToDelete = scanner.nextLine();
                        System.out.println("Enter Date to delete (YYYY-MM-DD):");
                        String dateToDelete = scanner.nextLine();
                        System.out.println("Enter ScheduledStartTime to delete (HH:MM:SS):");
                        String startTimeToDelete = scanner.nextLine();
                        editor.deleteTripOffering(tripNumberToDelete, dateToDelete, startTimeToDelete);
                        break;
                    case 3:
                        editor.addTripOfferings();
                        break;
                    case 4:
                        System.out.println("Enter TripNumber to change driver:");
                        String tripNumberToChangeDriver = scanner.nextLine();
                        System.out.println("Enter Date to change driver (YYYY-MM-DD):");
                        String dateToChangeDriver = scanner.nextLine();
                        System.out.println("Enter ScheduledStartTime to change driver (HH:MM:SS):");
                        String startTimeToChangeDriver = scanner.nextLine();
                        System.out.println("Enter new DriverName:");
                        String newDriverName = scanner.nextLine();
                        editor.changeDriver(tripNumberToChangeDriver, dateToChangeDriver, startTimeToChangeDriver, newDriverName);
                        break;
                    case 5:
                        System.out.println("Enter TripNumber to change bus:");
                        String tripNumberToChangeBus = scanner.nextLine();
                        System.out.println("Enter Date to change bus (YYYY-MM-DD):");
                        String dateToChangeBus = scanner.nextLine();
                        System.out.println("Enter ScheduledStartTime to change bus (HH:MM:SS):");
                        String startTimeToChangeBus = scanner.nextLine();
                        System.out.println("Enter new BusID:");
                        int newBusID = scanner.nextInt();
                        scanner.nextLine();  // Consume newline
                        editor.changeBus(tripNumberToChangeBus, dateToChangeBus, startTimeToChangeBus, newBusID);
                        break;
                    case 6:
                        System.out.println("Exiting...");
                        scanner.close();
                        System.exit(0);
                        break;
                    default:
                        System.out.println("Invalid choice. Please try again.");
                }

                // Adding a new line for better readability
                System.out.println();
            }
        } else {
            System.out.println("Failed to connect to the database.");
        }
    }

    static class TripSchedule {
        private static final String DATABASE_URL = "jdbc:ucanaccess://./resources/pomonaTransitSystem.accdb";

        public static void displaySchedule(String startLocationName, String destinationName, String date) {
            // Validate date format
            if (!isValidDate(date)) {
                System.out.println("Invalid date format. Please use YYYY-MM-DD.");
                return;
            }

            String query = "SELECT TripOffering.TripNumber, TripOffering.Date, TripOffering.ScheduledStartTime, TripOffering.ScheduledArrivalTime, " +
                    "TripOffering.DriverName, TripOffering.BusID " +
                    "FROM TripOffering " +
                    "JOIN Trip ON TripOffering.TripNumber = Trip.TripNumber " +
                    "WHERE Trip.StartLocationName = ? AND Trip.DestinationName = ? AND TripOffering.Date = ?";

            try (Connection connection = DriverManager.getConnection(DATABASE_URL);
                 PreparedStatement preparedStatement = connection.prepareStatement(query)) {

                preparedStatement.setString(1, startLocationName);
                preparedStatement.setString(2, destinationName);
                preparedStatement.setDate(3, Date.valueOf(date));

                try (ResultSet resultSet = preparedStatement.executeQuery()) {
                    System.out.println("Schedule for trips from " + startLocationName + " to " + destinationName + " on " + date + ":");

                    boolean hasResults = false;
                    while (resultSet.next()) {
                        hasResults = true;
                        String tripNumber = resultSet.getString("TripNumber");
                        String scheduledStartTime = resultSet.getString("ScheduledStartTime").split("\\.")[0];
                        String scheduledArrivalTime = resultSet.getString("ScheduledArrivalTime").split("\\.")[0];
                        String driverName = resultSet.getString("DriverName");
                        int busID = resultSet.getInt("BusID");

                        System.out.println("TripNumber: " + tripNumber + ", ScheduledStartTime: " + scheduledStartTime +
                                ", ScheduledArrivalTime: " + scheduledArrivalTime + ", DriverName: " + driverName + ", BusID: " + busID + "\n");
                    }
                    if (!hasResults) {
                        System.out.println("No trips found for the given criteria.");
                    }
                }
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }

        private static boolean isValidDate(String date) {
            SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
            sdf.setLenient(false);
            try {
                sdf.parse(date);
                return true;
            } catch (ParseException e) {
                return false;
            }
        }
    }

    static class TripOfferingEditor {
        private static final String DATABASE_URL = "jdbc:ucanaccess://./resources/pomonaTransitSystem.accdb";

        public void deleteTripOffering(String tripNumber, String date, String scheduledStartTime) {
            String deleteQuery = "DELETE FROM TripOffering WHERE TripNumber = ? AND Date = ? AND ScheduledStartTime = ?";

            try (Connection connection = DriverManager.getConnection(DATABASE_URL);
                 PreparedStatement preparedStatement = connection.prepareStatement(deleteQuery)) {

                preparedStatement.setString(1, tripNumber);
                preparedStatement.setDate(2, Date.valueOf(date));
                preparedStatement.setTime(3, Time.valueOf(scheduledStartTime));

                int rowsAffected = preparedStatement.executeUpdate();
                if (rowsAffected > 0) {
                    System.out.println("Trip offering deleted successfully.");
                } else {
                    System.out.println("No matching trip offering found.");
                }

            } catch (SQLException e) {
                e.printStackTrace();
            }
        }

        public void addTripOfferings() {
            Scanner scanner = new Scanner(System.in);
            boolean moreTrips = true;

            while (moreTrips) {
                System.out.println("Enter TripNumber:");
                String tripNumber = scanner.nextLine();
                System.out.println("Enter Date (YYYY-MM-DD):");
                String date = scanner.nextLine();
                System.out.println("Enter ScheduledStartTime (HH:MM:SS):");
                String scheduledStartTime = scanner.nextLine();
                System.out.println("Enter ScheduledArrivalTime (HH:MM:SS):");
                String scheduledArrivalTime = scanner.nextLine();
                System.out.println("Enter DriverName:");
                String driverName = scanner.nextLine();
                System.out.println("Enter BusID:");
                int busID = scanner.nextInt();
                scanner.nextLine(); // Consume newline

                String insertQuery = "INSERT INTO TripOffering (TripNumber, Date, ScheduledStartTime, ScheduledArrivalTime, DriverName, BusID) " +
                        "VALUES (?, ?, ?, ?, ?, ?)";

                try (Connection connection = DriverManager.getConnection(DATABASE_URL);
                     PreparedStatement preparedStatement = connection.prepareStatement(insertQuery)) {

                    preparedStatement.setString(1, tripNumber);
                    preparedStatement.setDate(2, Date.valueOf(date));
                    preparedStatement.setTime(3, Time.valueOf(scheduledStartTime));
                    preparedStatement.setTime(4, Time.valueOf(scheduledArrivalTime));
                    preparedStatement.setString(5, driverName);
                    preparedStatement.setInt(6, busID);

                    int rowsAffected = preparedStatement.executeUpdate();
                    if (rowsAffected > 0) {
                        System.out.println("Trip offering added successfully.");
                    } else {
                        System.out.println("Failed to add trip offering.");
                    }

                } catch (SQLException e) {
                    e.printStackTrace();
                }

                System.out.println("Do you want to add more trips? (yes/no):");
                String response = scanner.nextLine();
                moreTrips = response.equalsIgnoreCase("yes");
            }
        }

        public void changeDriver(String tripNumber, String date, String scheduledStartTime, String newDriverName) {
            String updateQuery = "UPDATE TripOffering SET DriverName = ? WHERE TripNumber = ? AND Date = ? AND ScheduledStartTime = ?";

            try (Connection connection = DriverManager.getConnection(DATABASE_URL);
                 PreparedStatement preparedStatement = connection.prepareStatement(updateQuery)) {

                preparedStatement.setString(1, newDriverName);
                preparedStatement.setString(2, tripNumber);
                preparedStatement.setDate(3, Date.valueOf(date));
                preparedStatement.setTime(4, Time.valueOf(scheduledStartTime));

                int rowsAffected = preparedStatement.executeUpdate();
                if (rowsAffected > 0) {
                    System.out.println("Driver changed successfully.");
                } else {
                    System.out.println("No matching trip offering found.");
                }

            } catch (SQLException e) {
                e.printStackTrace();
            }
        }

        public void changeBus(String tripNumber, String date, String scheduledStartTime, int newBusID) {
            String updateQuery = "UPDATE TripOffering SET BusID = ? WHERE TripNumber = ? AND Date = ? AND ScheduledStartTime = ?";

            try (Connection connection = DriverManager.getConnection(DATABASE_URL);
                 PreparedStatement preparedStatement = connection.prepareStatement(updateQuery)) {

                preparedStatement.setInt(1, newBusID);
                preparedStatement.setString(2, tripNumber);
                preparedStatement.setDate(3, Date.valueOf(date));
                preparedStatement.setTime(4, Time.valueOf(scheduledStartTime));

                int rowsAffected = preparedStatement.executeUpdate();
                if (rowsAffected > 0) {
                    System.out.println("Bus changed successfully.");
                } else {
                    System.out.println("No matching trip offering found.");
                }

            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }
}
